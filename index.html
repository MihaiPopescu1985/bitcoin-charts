---
layout: dashboard
title: Bitcoin charts
---
<div class="dashboard-container">
    <div class="w3-card-4 w3-hover-shadow" data-chart-id="BTCAmountChart">
        <div class="w3-container w3-center w3-padding-16">
            <h3>Daily BTC amount transactioned and Close Price</h3>
        </div>
        <div class="chart-container">
            <canvas id="BTCAmountChart"></canvas>
        </div>
        </div>
</div>

<div id="cardModal" class="w3-modal">
    <div class="w3-modal-content w3-animate-zoom">
        <span class="close-button" onclick="closeModal()">&times;</span>
        <div id="modalContent">
            </div>
    </div>
</div>

<script>
    // Global available data
    window.btcDailyAmountData = {{ site.data.daily_amounts | jsonify }};
    window.btcDailyPriceData = {{ site.data.daily_close_price | jsonify }};

    // Access the data from the global variables
    const amountData = window.btcDailyAmountData;
    const priceData = window.btcDailyPriceData;

    // Function to transform data into the expected format
    function transformData(data) {
        return Object.entries(data).map(([time, value]) => ({ time, value }));
    }

    // Transform both datasets
    const amountArray = transformData(amountData);
    const priceArray = transformData(priceData);

    // Get year and month from date string
    function getYearMonth(dateString) {
        return dateString.substring(0, 7); // "YYYY-MM"
    }

    function getDay(dateString) {
        return dateString.substring(8); // "DD"
    }

    // Group data by month
    const monthlyAmountData = {};
    amountArray.forEach(item => {
        const yearMonth = getYearMonth(item.time);
        const day = getDay(item.time);
        if (!monthlyAmountData[yearMonth]) {
            monthlyAmountData[yearMonth] = [];
        }
        monthlyAmountData[yearMonth].push({
            time: day,
            tx_count: item.value
        });
    });

    const monthlyPriceData = {};
    priceArray.forEach(item => {
        const yearMonth = getYearMonth(item.time);
        const day = getDay(item.time);
        if (!monthlyPriceData[yearMonth]) {
            monthlyPriceData[yearMonth] = [];
        }
        monthlyPriceData[yearMonth].push({
            time: day,
            close: item.value
        });
    });

    // Get sorted month keys (assuming both datasets have the same months)
    const monthKeys = Object.keys(monthlyAmountData).sort();
    let currentMonthIndex = monthKeys.length - 1; // Start with the last month

    // Store the initial graphics configurations
    const chartConfigs = {};
    // Store the current graphics instances (cards and modals)
    const activeCharts = {};

    function initializeCharts() {
        // BTC Amount and Price Chart Configuration
        chartConfigs.BTCAmountChart = {
            type: 'bar',
            data: {
                labels: [], // These will be populated by updateChart()
                datasets: [{
                    label: '', // Populated by updateChart()
                    data: [], // Populated by updateChart()
                    borderColor: 'rgba(54, 162, 235, 1)',
                    backgroundColor: 'rgba(54, 162, 235, 0.5)', // Added background color for bars
                    borderWidth: 1,
                    yAxisID: 'y-amount'
                }, {
                    label: '', // Populated by updateChart()
                    data: [], // Populated by updateChart()
                    type: 'line',
                    borderColor: 'rgba(255, 99, 132, 1)',
                    backgroundColor: 'rgba(255, 99, 132, 0.2)', // Added background color for line area
                    borderWidth: 2,
                    fill: false, // Changed to true if you want the area filled
                    yAxisID: 'y-price'
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false, // Important for scaling
                plugins: {
                    title: { display: false } // Title already in card
                },
                scales: {
                    'y-amount': {
                        type: 'linear',
                        display: true,
                        position: 'left',
                        beginAtZero: true,
                        title: {
                            display: true,
                            text: 'BTC Amount'
                        }
                    },
                    'y-price': {
                        type: 'logarithmic', // Use logarithmic scale for price
                        display: true,
                        position: 'right',
                        beginAtZero: false, // Prices don't start at zero
                        title: {
                            display: true,
                            text: 'BTC Close Price'
                        },
                        grid: {
                            drawOnChartArea: false, // Only draw grid lines for the primary Y axis
                        },
                    },
                }
            }
        };

        // Initialize the BTCAmountChart in its card
        const ctx = document.getElementById('BTCAmountChart')?.getContext('2d');
        if (ctx) {
            activeCharts.BTCAmountChart = new Chart(ctx, chartConfigs.BTCAmountChart);
            updateChart(); // Call updateChart to populate initial data
        }
    }

    // Function to update the chart data based on the current month
    function updateChart() {
        const currentMonth = monthKeys[currentMonthIndex];
        const monthAmountData = monthlyAmountData[currentMonth];
        const monthPriceData = monthlyPriceData[currentMonth];

        const labels = monthAmountData.map(item => item.time);

        // Determine which chart instance to update: the one in the card or the one in the modal
        const chartToUpdate = activeCharts.modalChartInstance || activeCharts.BTCAmountChart;

        if (chartToUpdate) {
            chartToUpdate.data.labels = labels;
            chartToUpdate.data.datasets[0].label = "BTC Amount - " + currentMonth;
            chartToUpdate.data.datasets[0].data = monthAmountData.map(item => item.tx_count);

            chartToUpdate.data.datasets[1].label = "BTC Close Price - " + currentMonth;
            chartToUpdate.data.datasets[1].data = monthPriceData.map(item => item.close);

            chartToUpdate.update();
        }

        // Enable/disable buttons based on current month index, only if they exist (i.e., in modal)
        const prevButton = document.getElementById('modalPrevButton');
        const nextButton = document.getElementById('modalNextButton');

        if (prevButton && nextButton) {
            prevButton.disabled = (currentMonthIndex === 0);
            nextButton.disabled = (currentMonthIndex === monthKeys.length - 1);
        }
    }

    // Wait for DOM
    document.addEventListener('DOMContentLoaded', () => {
        initializeCharts();
    });

    const cardModal = document.getElementById('cardModal');
    const modalContentDiv = document.getElementById('modalContent');
    let currentExpandedChartId = null;

    // Open the modal and extend card
    document.querySelectorAll('.w3-card-4').forEach(card => {
        card.addEventListener('click', function() {
            const chartId = this.dataset.chartId;
            const cardTitle = this.querySelector('h3').textContent;

            if (chartId && chartConfigs[chartId]) {
                currentExpandedChartId = chartId;

                // Destroy the chart instance in the original card
                if (activeCharts[chartId]) {
                    activeCharts[chartId].destroy();
                    delete activeCharts[chartId];
                }

                // Inject modal content including buttons
                modalContentDiv.innerHTML = `
                    <h3 class="w3-center w3-padding-16">${cardTitle}</h3>
                    <div class="chart-container" style="height: auto; max-height: 80vh;">
                        <canvas id="modalChart"></canvas>
                    </div>
                    <div class="w3-container w3-center w3-padding-small">
                        <button id="modalPrevButton" class="w3-button w3-light-grey w3-round-large w3-margin-right">Previous Month</button>
                        <button id="modalNextButton" class="w3-button w3-light-grey w3-round-large">Next Month</button>
                    </div>
                `;

                const modalChartCtx = document.getElementById('modalChart').getContext('2d');
                // Deep clone the config to ensure independence
                const configForModal = JSON.parse(JSON.stringify(chartConfigs[chartId]));
                activeCharts['modalChartInstance'] = new Chart(modalChartCtx, configForModal);

                // Add event listeners for navigation buttons in the modal
                document.getElementById('modalPrevButton').addEventListener('click', () => {
                    currentMonthIndex = Math.max(0, currentMonthIndex - 1);
                    updateChart();
                });

                document.getElementById('modalNextButton').addEventListener('click', () => {
                    currentMonthIndex = Math.min(monthKeys.length - 1, currentMonthIndex + 1);
                    updateChart();
                });

                // Update the chart in the modal to show the correct month data
                updateChart(); // This will use activeCharts.modalChartInstance now

                cardModal.style.display = 'block';
            }
        });
    });

    function closeModal() {
        cardModal.style.display = 'none';

        // Destroy the chart in the modal
        if (activeCharts['modalChartInstance']) {
            activeCharts['modalChartInstance'].destroy();
            delete activeCharts['modalChartInstance'];
        }

        // Graphic restore in the original card
        if (currentExpandedChartId) {
            const originalCanvas = document.getElementById(currentExpandedChartId);
            if (originalCanvas) {
                const originalCtx = originalCanvas.getContext('2d');

                originalCtx.clearRect(0, 0, originalCanvas.width, originalCanvas.height);
                activeCharts[currentExpandedChartId] = new Chart(originalCtx, chartConfigs[currentExpandedChartId]);

                // Update the chart in the original card to show the current month data
                updateChart(); // This will use activeCharts.BTCAmountChart now
            }
        }
        currentExpandedChartId = null; // Reset ID
    }

    // Close the modal on click outside of its area
    window.onclick = function(event) {
        if (event.target == cardModal) {
            closeModal();
        }
    }
</script>
